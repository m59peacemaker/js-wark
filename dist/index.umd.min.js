!function(e,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports):"function"==typeof define&&define.amd?define(["exports"],o):o((e="undefined"!=typeof globalThis?globalThis:e||self).wark={})}(this,(function(e){"use strict";const o=()=>({cache:new Map,post_computations:[]});var t=Object.freeze({__proto__:null,perform:e=>e.perform(o())});const p=e=>({perform:e}),c=e=>o=>t=>e((e=>o.perform(e)(t.perform(e)))),r=c(p),n=e=>o=>t=>e((e=>o(t.perform(e)).perform(e))),u=n(p),s=e=>o=>e((e=>o.perform(e).perform(e))),m=s(p),a=e=>o=>t=>p=>e((e=>o(t.perform(e))(p.perform(e)))),d=a(p),i=e=>o=>t=>p=>c=>e((e=>o(t.perform(e))(p.perform(e))(c.perform(e)))),l=i(p),f=e=>o=>t=>e((e=>o(t.perform(e)))),_=f(p),g=e=>o=>e((()=>o)),j=g(p);var h=Object.freeze({__proto__:null,apply:r,chain:u,construct:p,from:e=>p((()=>e())),join:m,lift_2:d,lift_3:l,map:_,of:j});const v=(e,o)=>{const t=o.cache.get(e);if(t)return t;{const t={};return o.cache.set(e,t),t.compute_value="object"!=typeof e&&e(o),t}},z=e=>"value"in e?e.value:e.value=e.compute_value(),w=e=>!1!==e.compute_value,y=Symbol("undetermined"),b=new FinalizationRegistry((e=>e())),S=(e,o)=>{const t={};return b.register(e,o),()=>b.unregister(t)},M=()=>{},O={compute:()=>!1,join_propagation:()=>M},T=e=>({perform:()=>e,updates:O}),x={occurrences:O,completed:T(!0)},k=e=>({perform:()=>e,updates:x}),D=e=>o=>{if(o.completed.perform())return k(e);let t=e;const p=o.occurrences.join_propagation((e=>{const p=v(o.occurrences.compute,e);if(w(p)){const o=z(p);e.post_computations.push((()=>{t=o}))}})),c=o.completed.updates.join_propagation((e=>{w(v(o.completed.updates.compute,e))&&e.post_computations.push((()=>{p(),c(),r()}))})),r=S(o,(()=>{p(),c()}));return{updates:o,perform:()=>t}},R=(e,o)=>(o.add(e),()=>o.delete(e)),E=(e,t,p)=>{const c=o();c.cache.set(e.compute,{compute_value:()=>p,value:p});for(const e of t)e(c);for(const e of c.post_computations)e()},W=e=>{const o=new Set,t={compute:{},join_propagation:e=>R(e,o)};return e((e=>E(t,o,e))),t},A=e=>({occurrences:W(e),completed:T(!1)}),F=()=>{let e;const o=A((o=>e=o));return o.produce=e,o},I=e=>o=>({compute:t=>{const p=v(o.compute,t);return!!w(p)&&(()=>e(z(p)))},join_propagation:o.join_propagation}),q=e=>{const o=new Map,t=new Map;let p=null,c=null,r=null,n=null;const u=e=>{for(const t of o.values())t(e)},s=e=>{for(const o of t.values())o(e)},m=()=>{const o=e.perform();c=o.occurrences.join_propagation((e=>{w(v(o.occurrences.compute,e))&&v(u,e)}))},a=()=>{const o=e.perform();n=o.completed.updates.join_propagation((e=>{w(v(o.completed.updates.compute,e))&&v(s,e)}))};return{occurrences:{compute:o=>{if(e.updates.completed.perform()){const t=e.perform(),p=v(t.occurrences.compute,o);return!!w(p)&&(()=>z(p))}{const t=v(e.updates.occurrences.compute,o);if(w(t)){const e=z(t),p=v(e.occurrences.compute,o);return!!w(p)&&(()=>z(p))}{const t=e.perform(),p=v(t.occurrences.compute,o);return!!w(p)&&(()=>z(p))}}},join_propagation:t=>{const r=Symbol();return o.set(r,t),1===o.size&&(p=e.updates.occurrences.join_propagation((t=>{w(v(e.updates.occurrences.compute,t))&&(v(u,t),t.post_computations.push((e=>{o.size>0&&(c(),m())})))})),m()),()=>{o.delete(r),0===o.size&&(p(),p=null,c(),c=null)}}},completed:{perform:()=>e.updates.completed.perform()&&e.perform().completed.perform(),updates:{compute:o=>{if(e.updates.completed.perform()){const t=e.perform();return(t.completed.perform()||w(v(t.completed.updates.compute,o)))&&(()=>!0)}{const t=v(e.updates.occurrences.compute,o),p=w(t)?z(t):e.perform();return(p.completed.perform()||w(v(p.completed.updates.compute,o)))&&w(v(e.updates.completed.updates.compute,o))&&(()=>!0)}},join_propagation:o=>{const p=Symbol();return t.set(p,o),1===t.size&&(r=e.updates.completed.updates.join_propagation((o=>{w(v(e.updates.completed.updates.compute,o))&&(v(s,o),o.post_computations.push((e=>{t.size>0&&(n(),a())})))})),a()),()=>{t.delete(p),0===t.size&&(r(),r=null,n(),n=null)}}}}}};var B=Object.freeze({__proto__:null,combine:e=>o=>{let t=y,p=y;const c=new Map,r=new Map,n={occurrences:{compute:t=>{let p=!1;const c=[];for(const e of o)if(e.updates.completed.perform())c.push(e.perform);else{const o=v(e.updates.occurrences.compute,t);w(o)?(p=!0,c.push((()=>z(o)))):c.push(e.perform)}return p&&(()=>e(c.map((e=>e()))))},join_propagation:e=>{const o=Symbol();return c.set(o,e),()=>c.delete(o)}},completed:{perform:()=>((p=y)&&(p=o.every((e=>e.updates.completed.perform()))),p),updates:{compute:e=>!!o.every((o=>o.updates.completed.perform()||w(v(o.updates.completed.updates.compute,e))))&&(()=>!0),join_propagation:e=>{const o=Symbol();return r.set(o,e),()=>r.delete(o)}}}},u=e=>{for(const o of c.values())o(e);const o=v(n.occurrences.compute,e);w(o)&&e.post_computations.push((e=>{t="value"in o?o.value:y}))},s=e=>{for(const o of r.values())o(e);const o=v(n.completed.updates.compute,e);w(o)&&e.post_computations.push((e=>{p="value"in o?o.value:y}))};for(const e of o)if(!1===e.updates.completed.perform()){const o=e.updates.occurrences.join_propagation((e=>{v(u,e)})),t=e=>{w(n.completed.updates.compute)&&(v(s,e),e.post_computations.push((()=>{o(),p(),c()})))},p=e.updates.completed.updates.join_propagation((e=>v(t,e))),c=S(n,(()=>{o(),p()}))}return{perform:()=>(t===y&&(t=e(o.map((e=>e.perform())))),t),updates:n}},create:e=>D(e)(F()),join:e=>{const o=new Map,t=new Map;let p=null,c=null,r=null,n=null;const u=e=>{for(const t of o.values())t(e)},s=e=>{for(const o of t.values())o(e)},m=()=>{const o=e.perform();c=o.updates.occurrences.join_propagation((e=>{w(v(o.updates.occurrences.compute,e))&&v(u,e)}))},a=()=>{const o=e.perform();n=o.updates.completed.updates.join_propagation((e=>{w(v(o.updates.completed.updates.compute,e))&&v(s,e)}))};return{perform:()=>e.perform().perform(),updates:{occurrences:{compute:o=>{if(e.updates.completed.perform()){const t=e.perform(),p=v(t.updates.occurrences.compute,o);return!!w(p)&&(()=>z(p))}{const t=v(e.updates.occurrences.compute,o);if(w(t)){const e=z(t),p=v(e.updates.occurrences.compute,o);return w(p)?()=>z(p):e.perform}{const t=e.perform(),p=v(t.updates.occurrences.compute,o);return!!w(p)&&(()=>z(p))}}},join_propagation:t=>{const r=Symbol();return o.set(r,t),1===o.size&&(p=e.updates.occurrences.join_propagation((t=>{w(v(e.updates.occurrences.compute,t))&&(v(u,t),t.post_computations.push((e=>{o.size>0&&(c(),m())})))})),m()),()=>{o.delete(r),0===o.size&&(p(),p=null,c(),c=null)}}},completed:{perform:()=>e.updates.completed.perform()&&e.perform().updates.completed.perform(),updates:{compute:o=>{if(e.updates.completed.perform()){const t=e.perform().updates;return(t.completed.perform()||w(v(t.completed.updates.compute,o)))&&(()=>!0)}{const t=v(e.updates.occurrences.compute,o),p=w(t)?z(t):e.perform();return(p.updates.completed.perform()||w(v(p.updates.completed.updates.compute,o)))&&w(v(e.updates.completed.updates.compute,o))&&(()=>!0)}},join_propagation:o=>{const p=Symbol();return t.set(p,o),1===t.size&&(r=e.updates.completed.updates.join_propagation((o=>{w(v(e.updates.completed.updates.compute,o))&&(v(s,o),o.post_computations.push((e=>{t.size>0&&(n(),a())})))})),a()),()=>{t.delete(p),0===t.size&&(r(),r=null,n(),n=null)}}}}}}},map:e=>o=>{let t=y;const p=()=>(t===y&&(t=e(o.perform())),t);if(o.updates.completed.perform())return{updates:x,perform:p};const c=I(e)(o.updates.occurrences),r=c.join_propagation((e=>{const o=v(c.compute,e);w(o)&&e.post_computations.push((()=>{t="value"in o?o.value:y}))})),n=o.updates.completed.updates.join_propagation((e=>{w(o.updates.completed.updates.compute)&&e.post_computations.push((()=>{r(),n(),s()}))})),u={occurrences:c,completed:o.updates.completed},s=S(u,(()=>{r(),n()}));return{perform:p,updates:u}},of:k,switching:q,updates:e=>e.updates});const C=Symbol("nothing"),G=(e,o,t)=>{const p=new Map,c=new Map;let r=M,n=M,u=M,s=M;const m=e=>{for(const o of p.values())o(e)},a=e=>{for(const o of c.values())o(e)},d=()=>{u=o.completed.updates.join_propagation((e=>{w(v(o.completed.updates.compute,e))&&(v(a,e),e.post_computations.push((()=>{r(),u()})))})),s=t.completed.updates.join_propagation((e=>{w(v(t.completed.updates.compute,e))&&(v(a,e),e.post_computations.push((()=>{n(),s()})))}))};return{completed:{updates:{compute:e=>{const p=v(o.completed.updates.compute,e),c=v(t.completed.updates.compute,e),r=o.completed.perform()||w(p),n=t.completed.perform()||w(c);return!!(r&&n)&&(()=>!0)},join_propagation:e=>{const o=Symbol();return c.set(o,e),c.size+p.size===1&&d(),()=>{c.delete(o),c.size+p.size===0&&(u(),s())}}},perform:()=>o.completed.perform()&&t.completed.perform()},occurrences:{compute:p=>{if(o.completed.perform()){const o=v(t.occurrences.compute,p),c=w(o)?e(C)(z(o)):C;return c!==C&&(()=>c)}if(t.completed.perform()){const t=v(o.occurrences.compute,p),c=w(t)?e(C)(z(t)):C;return c!==C&&(()=>c)}{const c=v(o.occurrences.compute,p),r=v(t.occurrences.compute,p),n=w(c),u=w(r),s=n||u?e(n?z(c):C)(u?z(r):C):C;return s!==C&&(()=>s)}},join_propagation:e=>{const a=Symbol();return p.set(a,e),1===p.size&&(!1===o.completed.perform()&&(r=o.occurrences.join_propagation((e=>{v(m,e)}))),!1===t.completed.perform()&&(n=t.occurrences.join_propagation((e=>{v(m,e)}))),0===c.size&&d()),()=>{p.delete(a),0===p.size&&(r(),n(),r=M,n=M,0===c.size&&(u(),s()))}}}}},H=e=>o=>t=>o.completed.perform()&&t.completed.perform()?x:o.completed.perform()?((e,o,t)=>({occurrences:{compute:o=>{const p=v(t.occurrences.compute,o),c=w(p)?e(z(p))(C):C;return c!==C&&(()=>c)},join_propagation:t.occurrences.join_propagation},completed:t.completed}))(e,0,t):t.completed.perform()?((e,o,t)=>({occurrences:{compute:t=>{const p=v(o.occurrences.compute,t),c=w(p)?e(z(p))(C):C;return c!==C&&(()=>c)},join_propagation:o.occurrences.join_propagation},completed:o.completed}))(e,o):G(e,o,t),J=H((e=>o=>o===C?e:o)),K=e=>{const o=new Set;let t;const p=e=>E(c,o,e),c={compute:{},join_propagation:c=>{const r=0===o.size,n=R(c,o);return r&&(t=e(p)),()=>{n(),0===o.size&&t()}}};return c},L=e=>{let o=!1;const t={updates:{compute:o=>w(v(e.compute,o))&&(()=>!0),join_propagation:e.join_propagation},perform:()=>o},p=t=>{const p=v(e.compute,t);w(p)&&t.post_computations.push((e=>{o=!0,c(),r()}))},c=e.join_propagation((e=>{v(p,e)})),r=S(t,c);return t},N=e=>o=>({compute:t=>{const p=v(o.compute,t);if(w(p)){const o=z(p);return!!e(o)&&(()=>o)}return!1},join_propagation:o.join_propagation}),P=e=>o=>t=>({compute:p=>{const c=v(t.compute,p);return!!w(c)&&(()=>e(o.perform(p))(z(c)))},join_propagation:t.join_propagation}),Q=e=>o=>t=>t.completed.perform()?x:{occurrences:P(e)(o)(t.occurrences),completed:t.completed},U=Q((e=>o=>e)),V=({ms:e})=>{const t=new Set;let p=!1;const c={compute:{},join_propagation:e=>R(e,t)},r={perform:()=>p,updates:{compute:{},join_propagation:c.join_propagation}},n=new WeakRef(c.compute),u=new WeakRef(r.updates.compute),s=setTimeout((()=>{const c=o(),r=n.deref(),s=u.deref();void 0!==r&&c.cache.set(r,{compute_value:()=>e,value:e}),void 0!==s&&c.cache.set(s,{compute_value:()=>!0,value:!0});for(const e of t)e(c);p=!0;for(const e of c.post_computations)e()}),e),m=S(c.compute,(()=>{void 0===u.deref()&&(clearTimeout(s),a())})),a=S(r.updates.compute,(()=>{void 0===n.deref()&&(clearTimeout(s),m())}));return{occurrences:c,completed:r}};var X=Object.freeze({__proto__:null,alt:J,calling:e=>o=>{if(o.completed.perform())return x;{const t={compute:t=>{const p=v(o.occurrences.compute,t);return!!w(p)&&(()=>e(z(p)))},join_propagation:o.occurrences.join_propagation},p=e=>{const o=v(t.compute,e);w(o)&&z(o)},c=o.occurrences.join_propagation((e=>{v(p,e)})),r=e=>{w(v(o.completed.updates.compute,e))&&e.post_computations.push((()=>{c(),n()}))},n=o.completed.updates.join_propagation((e=>{v(r,e)}));return{occurrences:t,completed:o.completed}}},complete_on:e=>o=>({occurrences:o.occurrences,completed:e.completed.perform()?T(!0):L(e.occurrences)}),completed:e=>({perform:e.completed.perform,updates:{occurrences:e.completed.updates,completed:e.completed}}),completion:e=>({completed:e.completed,occurrences:e.completed.updates}),construct_on_demand_producer:e=>({occurrences:K(e),completed:T(!1)}),construct_producer:A,create:F,filter:e=>o=>o.completed.perform()?x:{occurrences:N(e)(o.occurrences),completed:o.completed},hold:D,map:e=>o=>o.completed.perform()?x:{occurrences:I(e)(o.occurrences),completed:o.completed},merge_2:H,never:x,nothing:C,scan:e=>o=>t=>{if(t.completed.perform())return k(o);let p=o;const c={occurrences:{compute:o=>{const c=v(t.occurrences.compute,o);return!!w(c)&&(()=>e(z(c))(p))},join_propagation:t.occurrences.join_propagation},completed:t.completed},r=c.occurrences.join_propagation((e=>{const o=v(c.occurrences.compute,e);if(w(o)){const t=z(o);e.post_computations.push((()=>{p=t}))}})),n=c.completed.updates.join_propagation((e=>{w(v(c.completed.updates.compute,e))&&e.post_computations.push((()=>{r(),n(),u()}))})),u=S(c,(()=>{r(),n()}));return{updates:c,perform:()=>p}},snapshot:Q,switching:e=>q(D(x)(e)),tag:U,wait:V});const Y=e=>{const o={perform:t=>(t.cache.has(o)||t.cache.set(o,e(t)),t.cache.get(o))};return o},Z=c(Y),$=n(Y),ee=e=>Y((()=>e())),oe=f(Y),te=ee(Date.now),pe=oe((e=>new Date(e).toISOString()))(te),ce=s(Y),re=a(Y),ne=i(Y),ue=g(Y),se=Y((()=>(e=>{const o=new Map;return t=>{if(o.has(t))return o.get(t);const p=e(t);return o.set(t,p),p}})((e=>V({ms:e})))));var me=Object.freeze({__proto__:null,apply:Z,chain:$,construct:Y,from:ee,get:e=>e.perform(o()),iso8601_datetime:pe,join:ce,lift_2:re,lift_3:ne,map:oe,of:ue,unix_timestamp_ms:te,wait:({ms:e})=>oe((o=>o(e)))(se)});e.Action=t,e.Dynamic=B,e.Effect=h,e.Event=X,e.Sample=me}));
