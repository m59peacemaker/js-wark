!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).wark={})}(this,(function(t){"use strict";const e=(t,e,n)=>(!1===e.computed&&(e.computed=!0,e.value=n.compute(t)),e.value),n=Symbol("_nothing"),a=(t,a)=>{const o=t.cache.get(a);return o?e(t,o,a):n},o=new FinalizationRegistry((t=>t())),s=o.register.bind(o),c=t=>e=>{let o=t;const c=t=>{t.post_computations.push((t=>{const s=a(t,e);s!==n&&(o=s)}))},p={updates:e,perform:()=>o,propagate:c};e.dependants.add(p),s(p,(()=>e.dependants.delete(p)));const d=e.instant();return null!==d&&c(d),p},p=()=>({cache:new Map,computations:[],post_computations:[]}),d=()=>{let t;const e=(t=>{let e=null;const n={instant:()=>e,dependants:new Set};return t((t=>{e=p(),e.cache.set(n,{computed:!0,value:t});for(const t of n.dependants)t.propagate(e);for(const t of e.computations)t(e);for(const t of e.post_computations)t(e);e=null})),n})((e=>t=e));return e.produce=t,e},u=Symbol(),r=t=>e=>{const o={instant:e.instant,compute:o=>{const s=a(o,e);return s===n?n:t(s)},propagate:t=>{if(!t.cache.has(o)){t.cache.set(o,{computed:!1,value:n});for(const e of o.dependants)e.propagate(t)}},dependants:new Set};e.dependants.add(o);const s=e.instant();return null!==s&&s.cache.set(o,{computed:!1,value:n}),o};var i=Object.freeze({__proto__:null,create:t=>c(t)(d()),map:t=>e=>{let o=u;const s=r(t)(e.updates),c=t=>{t.post_computations.push((t=>{if(((t,e)=>{const n=t.cache.get(e);return n&&n.computed})(t,s)){const e=a(t,s);e!==n&&(o=e)}else o=u}))},p={updates:s,perform:()=>(o===u&&(o=t(e.perform())),o),propagate:c};s.dependants.add(p);const d=e.updates.instant();return null!==d&&c(d),p},updates:t=>t.updates});const l=Symbol("nothing"),m=()=>{},f={instant:()=>null,compute:()=>n,propagate:m,dependants:{add:m,delete:m}},h=t=>o=>c=>{let p=o;const d={instant:()=>o.instant()||c.instant(),compute:e=>{const o=a(e,c);if(o===n)return a(e,p);{e.post_computations.push((()=>{p.dependants.delete(d),o.dependants.add(d),p=o}));const n=t(p)(o);return a(e,n)}},propagate:t=>{if(!t.cache.has(d)){const a={computed:!1,value:n};t.cache.set(d,a);for(const e of d.dependants)e.propagate(t);t.computations.push((t=>e(t,a,d)))}},dependants:new Set};c.dependants.add(d),p.dependants.add(d),s(d,(()=>{c.dependants.delete(d),p.dependants.delete(d)}));const u=d.instant();if(null!==u){const t={computed:!1,value:n};u.cache.set(d,t),u.computations.push((n=>e(n,t,d)))}return d},g=t=>t=>t,_=h(g)(f),v=t=>{let e=null;const n={instant:()=>e,dependants:new Set},a=new WeakRef(n);return s(n,t((t=>{const n=a.deref();e=p(),e.cache.set(n,{computed:!0,value:t});for(const t of n.dependants)t.propagate(e);for(const t of e.computations)t(e);for(const t of e.post_computations)t(e);e=null}))),n},w=({ms:t})=>v((e=>{const n=setTimeout((()=>e(t)),t);return n.unref&&n.unref(),()=>clearTimeout(n)}));var b=Object.freeze({__proto__:null,calling:t=>o=>{const s={instant:o.instant,compute:e=>{const s=a(e,o);return s===n?n:t(s)},propagate:t=>{if(!t.cache.has(s)){const a={computed:!1,value:n};t.cache.set(s,a);for(const e of s.dependants)e.propagate(t);t.computations.push((t=>e(t,a,s)))}},dependants:new Set};o.dependants.add(s);const c=o.instant();if(null!==c){const t={computed:!1,value:n};c.cache.set(s,t),c.computations.push((n=>e(n,t,s)))}return s},exposed_producer:d,hold:c,map:r,merge_2_with:t=>e=>o=>{const s={instant:()=>e.instant()||o.instant(),compute:s=>{const c=a(s,e),p=a(s,o),d=c===n&&p===n?n:t(c===n?l:c)(p===n?l:p);return d===l?n:d},propagate:t=>{if(!t.cache.has(s)){t.cache.set(s,{computed:!1,value:n});for(const e of s.dependants)e.propagate(t)}},dependants:new Set};e.dependants.add(s),o.dependants.add(s);const c=s.instant();return null!==c&&c.cache.set(s,{computed:!1,value:n}),s},never:f,switch_updating:h,switching:_,tag:t=>e=>{const a={instant:e.instant,compute:t.perform,propagate:t=>{if(!t.cache.has(a)){t.cache.set(a,{computed:!1,value:n});for(const e of a.dependants)e.propagate(t)}},dependants:new Set};e.dependants.add(a);const o=e.instant();return null!==o&&o.cache.set(a,{computed:!1,value:n}),a},wait:w,weak_producer:v});const y=t=>{const e={perform:n=>(n.cache.has(e)||n.cache.set(e,t(n)),n.cache.get(e))};return e},S=t=>e=>y((n=>t(e.perform(n)))),j=y((()=>(t=>{const e=new Map;return n=>{if(e.has(n))return e.get(n);const a=t(n);return e.set(n,a),a}})((t=>w({ms:t})))));var x=Object.freeze({__proto__:null,get:t=>t.perform(p()),map:S,wait:({ms:t})=>S((e=>e(t)))(j)});t.Dynamic=i,t.Event=b,t.Sample=x,t.immediately=g,t.subsequently=t=>e=>t}));
